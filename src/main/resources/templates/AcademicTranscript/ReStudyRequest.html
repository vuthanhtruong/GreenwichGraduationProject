<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Re-study Request</title>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" th:href="@{/StudentReStudyRequest.css}">
</head>

<body>
<div class="win11-container">

    <!-- Toolbar -->
    <div class="search-toolbar unified-bar">

        <div class="toolbar-left">
            <a th:href="@{/student-home}" class="btn home-btn">
                <i class="fas fa-home"></i> Home
            </a>

            <h2 class="page-title">
                <i class="fas fa-redo"></i> Re-study Request
            </h2>
        </div>

        <div class="toolbar-right">
            <div class="total">
                <i class="fas fa-exclamation-triangle"></i>
                <span>
                    <strong>Failed Subjects:</strong>
                    <span th:text="${totalFail}">0</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    <div th:if="${errorMessage != null}" class="win11-alert error">
        <i class="fas fa-times-circle"></i>
        <span th:text="${errorMessage}"></span>
    </div>

    <div th:if="${successMessage != null}" class="win11-alert success">
        <i class="fas fa-check-circle"></i>
        <span th:text="${successMessage}"></span>
    </div>

    <!-- Table of Failed Subjects -->
    <div class="table-container">

        <!-- Has Failed Subjects -->
        <form th:if="${failTranscripts != null and not #lists.isEmpty(failTranscripts)}"
              th:action="@{/student-home/re-study-request/pay}"
              method="post"
              onsubmit="return validateSelection()">

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <table class="win11-table">
                <thead>
                <tr>
                    <th class="center" style="width: 50px;">
                        <i class="fas fa-check-square"></i>
                    </th>
                    <th><i class="fas fa-book"></i> Subject</th>
                    <th><i class="fas fa-id-card"></i> Subject ID</th>
                    <th class="right"><i class="fas fa-coins"></i> Re-study Fee</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="transcript : ${failTranscripts}"
                    th:with="fee=${reStudyFeeMap[transcript.subjectId]}">

                    <td class="center">
                        <input type="checkbox"
                               class="subject-checkbox"
                               th:name="selectedSubjects"
                               th:value="${transcript.subjectId}"
                               th:attr="data-fee=${fee != null ? fee : 0}"
                               onclick="updateTotal()" />
                    </td>

                    <td>
                        <strong th:text="${transcript.subjectName}"></strong>
                        <span class="badge danger">FAILED</span>
                    </td>

                    <td th:text="${transcript.subjectId}"></td>

                    <td class="right fee-cell">
                        <span th:text="${fee != null
                            ? #numbers.formatDecimal(fee,0,'COMMA',0,'POINT') + ' VND'
                            : 'N/A'}"></span>
                    </td>
                </tr>

                <!-- Total -->
                <tr class="total-row">
                    <td colspan="3" class="right total-label">Total Cost:</td>
                    <td class="right total-value">
                        <span id="totalCost">0 VND</span>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- Pay Btn -->
            <div class="actions-right">
                <button type="submit" class="btn primary large" id="payBtn" disabled>
                    <i class="fas fa-credit-card"></i> Confirm & Pay
                </button>
            </div>

        </form>

        <!-- No failed subjects -->
        <table class="win11-table"
               th:if="${failTranscripts == null or #lists.isEmpty(failTranscripts)}">
            <tbody>
            <tr>
                <td class="no-fail">
                    <i class="fas fa-check-circle"></i>
                    <strong>Congratulations!</strong>
                    <p>You have no failed subjects.</p>
                </td>
            </tr>
            </tbody>
        </table>

    </div>
</div>

<script>
    function updateTotal() {
        let total = 0;

        document.querySelectorAll('.subject-checkbox:checked').forEach(cb => {
            const fee = parseFloat(cb.dataset.fee || 0);
            if (!isNaN(fee)) total += fee;
        });

        document.getElementById('totalCost').textContent =
            new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(total);

        document.getElementById('payBtn').disabled = total === 0;
    }

    function validateSelection() {
        const count = document.querySelectorAll('.subject-checkbox:checked').length;
        if (count === 0) {
            alert('Please select at least one subject to re-study.');
            return false;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', updateTotal);
</script>

</body>
</html>
