<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Re-study Request</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" th:href="@{/StudentsList.css}">
</head>
<body>
<div class="win11-container">

    <!-- Toolbar - giống hệt trang Lecturers -->
    <div class="search-toolbar unified-bar">
        <div class="toolbar-left">
            <a th:href="@{/student-home}" class="btn home-btn">
                <i class="fas fa-home"></i> Home
            </a>
            <h2 class="page-title"><i class="fas fa-redo"></i> Re-study Request</h2>
        </div>
        <div class="toolbar-right">
            <div class="total">
                <i class="fas fa-exclamation-triangle"></i>
                <span><strong>Failed Subjects:</strong> <span th:text="${totalFail}">0</span></span>
            </div>
        </div>
    </div>

    <!-- Alert messages - dùng win11-alert đúng chuẩn -->
    <div th:if="${errorMessage != null}" class="win11-alert error">
        <i class="fas fa-times-circle"></i> <span th:text="${errorMessage}"></span>
    </div>
    <div th:if="${successMessage != null}" class="win11-alert success">
        <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
    </div>

    <!-- Student Info nhỏ gọn như Total Lecturers -->
    <div class="win11-alert info" style="margin: 15px 20px;">
        <i class="fas fa-user-graduate"></i>
        <strong th:text="${student?.fullName}">Student Name</strong>
        (ID: <span th:text="${student?.id}">N/A</span>) |
        Balance: <span th:text="${currentBalance != null ? #numbers.formatDecimal(currentBalance,0,'COMMA',0,'POINT') + ' VND' : 'N/A'}">0 VND</span>
    </div>

    <!-- Table container giống hệt Lecturers List -->
    <div class="table-container">
        <form th:action="@{/student-home/re-study-request/pay}" method="post"
              th:if="${failTranscripts != null and not #lists.isEmpty(failTranscripts)}"
              onsubmit="return validateSelection()">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <table class="win11-table">
                <thead>
                <tr>
                    <th style="width: 50px;"><i class="fas fa-check-square"></i></th>
                    <th><i class="fas fa-book"></i> Subject</th>
                    <th><i class="fas fa-id-card"></i> Subject ID</th>
                    <th style="text-align: right;"><i class="fas fa-coins"></i> Re-study Fee</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="transcript : ${failTranscripts}"
                    th:with="fee=${reStudyFeeMap[transcript.subjectId]}">
                    <td class="text-center">
                        <input type="checkbox"
                               class="subject-checkbox"
                               th:name="selectedSubjects"
                               th:value="${transcript.subjectId}"
                               th:attr="data-fee=${fee != null ? fee : 0}"
                               onclick="updateTotal()" />
                    </td>
                    <td>
                        <strong th:text="${transcript.subjectName}">Subject Name</strong>
                        <span class="badge danger" style="margin-left: 8px;">FAILED</span>
                    </td>
                    <td th:text="${transcript.subjectId}">N/A</td>
                    <td style="text-align: right; font-weight: 600;">
                            <span th:text="${fee != null ? #numbers.formatDecimal(fee,0,'COMMA',0,'POINT') + ' VND' : 'N/A'}">
                                0 VND
                            </span>
                    </td>
                </tr>

                <!-- Tổng tiền -->
                <tr class="total-row">
                    <td colspan="3" style="text-align: right; font-size: 1.2em; font-weight: bold;">
                        Total Cost:
                    </td>
                    <td style="text-align: right; font-size: 1.4em; color: var(--primary); font-weight: bold;">
                        <span id="totalCost">0 VND</span>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- Nút thanh toán giống nút Add Lecturer -->
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit" class="btn primary large" id="payBtn" disabled>
                    <i class="fas fa-credit-card"></i> Confirm & Pay
                </button>
            </div>
        </form>

        <!-- Không có môn trượt - dùng empty row giống Lecturers List -->
        <table class="win11-table" th:if="${failTranscripts == null or #lists.isEmpty(failTranscripts)}">
            <tbody>
            <tr>
                <td class="text-center success" style="padding: 60px; font-size: 1.3em;">
                    <i class="fas fa-check-circle" style="font-size: 2.5em; margin-bottom: 15px; display: block;"></i>
                    <strong>Congratulations!</strong><br>
                    You have no failed subjects.
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

<script type="text/javascript">
    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.subject-checkbox:checked').forEach(cb => {
            const fee = parseFloat(cb.dataset.fee || 0);
            if (!isNaN(fee)) total += fee;
        });

        document.getElementById('totalCost').textContent = new Intl.NumberFormat('vi-VN', {
            style: 'currency', currency: 'VND'
        }).format(total);

        document.getElementById('payBtn').disabled = total === 0;
    }

    function validateSelection() {
        if (document.querySelectorAll('.subject-checkbox:checked').length === 0) {
            alert('Please select at least one subject to re-study.');
            return false;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', updateTotal);
</script>
</body>
</html>