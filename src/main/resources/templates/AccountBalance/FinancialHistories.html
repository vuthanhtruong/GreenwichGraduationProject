<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Financial History</title>
    <link rel="stylesheet" th:href="@{/FinancialHistories.css}"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
</head>
<body>
<div class="win11-container">

    <!-- Header -->
    <header class="win11-title-bar">
        <div class="title-left">
            <h1>
                <i class="fas fa-receipt"></i>
                Financial History
            </h1>
            <p>
                <span th:text="${student.firstName} + ' ' + ${student.lastName}"></span>
                (<span th:text="${student.id}"></span>)
            </p>
        </div>
        <div class="banner-actions">
            <a class="btn" th:href="@{/student-home}">
                <i class="fas fa-home"></i> Home
            </a>
            <a class="btn primary" th:href="@{/student-home/deposit}">
                <i class="fas fa-wallet"></i> Deposit
            </a>
            <form th:action="@{/logout}" method="post" style="margin:0;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
        </div>
    </header>

    <!-- Stats -->
    <div class="win11-card">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Current Balance</h3>
                <p th:text="${
                    accountBalances != null
                    ? #numbers.formatDecimal(accountBalances.balance, 1, 'COMMA', 2, 'POINT') + ' USD'
                    : '0.00 USD'
                }"></p>
            </div>
            <div class="stat-card">
                <h3>Total Transactions</h3>
                <p th:text="${totalTransactions}"></p>
            </div>
            <div class="stat-card">
                <h3>Last Activity</h3>
                <p th:if="${histories != null and !histories.isEmpty()}"
                   th:text="${histories.getLast().getCreatedAt()}"></p>
                <p th:unless="${histories != null and !histories.isEmpty()}">—</p>
            </div>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="win11-card">
        <h2 style="margin-top:0;">
            <i class="fas fa-history"></i> Transaction History
        </h2>

        <!-- No data -->
        <div th:if="${histories == null or histories.isEmpty()}" style="text-align:center; padding:40px; color:#888;">
            <i class="fas fa-receipt" style="font-size:3rem; color:#ddd; display:block; margin-bottom:10px;"></i>
            <p>No transaction history yet.</p>
        </div>

        <!-- Table -->
        <table class="win11-table" th:if="${histories != null and !histories.isEmpty()}">
            <thead>
            <tr>
                <th>Date & Time</th>
                <th>Description</th>
                <th>Amount Change</th>
                <th>Balance After</th>
                <th>Status / Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="h : ${histories}">
                <!-- Date -->
                <td th:text="${#temporals.format(h.createdAt, 'dd MMM yyyy HH:mm')}"></td>

                <!-- Description -->
                <td th:text="${h.historyType}"></td>

                <!-- Amount Change -->
                <td>
                    <span th:if="${h.currentAmount != null and accountBalances != null}"
                          th:classappend="${h.currentAmount.compareTo(accountBalances.balance) > 0} ? 'amount positive' : 'amount negative'"
                          th:text="${
                              h.currentAmount.compareTo(accountBalances.balance) > 0
                              ? '+' + #numbers.formatDecimal(h.currentAmount.subtract(accountBalances.balance), 1, 'COMMA', 2, 'POINT')
                              : #numbers.formatDecimal(h.currentAmount.subtract(accountBalances.balance), 1, 'COMMA', 2, 'POINT')
                          } + ' USD'">
                    </span>
                    <span th:unless="${h.currentAmount != null and accountBalances != null}">—</span>
                </td>

                <!-- Balance After -->
                <td th:text="${
                    h.currentAmount != null
                    ? #numbers.formatDecimal(h.currentAmount, 1, 'COMMA', 2, 'POINT') + ' USD'
                    : '—'
                }"></td>

                <!-- Status / Continue Payment -->
                <td>
                    <form th:action="@{/student-home/deposit/retry}" method="post" style="display:inline;">
                        <input type="hidden" name="studentId" th:value="${student.id}" />
                        <button type="submit" class="status-link processing">
                            Continue Payment
                        </button>
                    </form>

                    <span th:unless="${h.status.name() == 'PROCESSING'}"
                          class="status"
                          th:text="${h.status}"></span>
                </td>

            </tr>
            </tbody>
        </table>
    </div>

</div>
</body>
</html>
