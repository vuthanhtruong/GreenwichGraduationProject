<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Specialized Assignment Submission</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" th:href="@{/StudentAssignmentDetail.css}">
</head>
<body>
<div class="win11-container">

    <!-- Success / Error Messages -->
    <th:block th:if="${message != null}">
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> <span th:text="${message}"></span>
        </div>
    </th:block>
    <th:block th:if="${errors != null and !errors.isEmpty()}">
        <div class="alert alert-danger" th:each="error : ${errors}">
            <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
        </div>
    </th:block>

    <!-- Back Button -->
    <div class="search-toolbar">
        <div class="toolbar-left">
            <form method="post" th:action="@{/classroom}" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="classId" th:value="${classId}" />
                <button type="submit" class="btn">
                    <i class="fas fa-arrow-left"></i> Back to Classroom
                </button>
            </form>
        </div>
        <div class="toolbar-center">
            <h2>Submit Specialized Assignment</h2>
        </div>
    </div>

    <!-- Assignment Info Panel -->
    <div class="panel">
        <h3><i class="fas fa-clipboard-list"></i> Assignment Details</h3>

        <div class="info-grid">
            <div>
                <strong>Title:</strong>
                <p th:text="${assignment.content} ?: 'No title'"></p>
            </div>
            <div>
                <strong>Created by:</strong>
                <p th:text="${assignment.getCreatorId()}"></p>
            </div>
            <div>
                <strong>Created at:</strong>
                <p th:text="${#temporals.format(assignment.createdAt, 'dd MMM yyyy HH:mm')}"></p>
            </div>
            <div>
                <strong>Deadline:</strong>
                <p>
                    <span th:text="${#temporals.format(assignment.deadline, 'dd MMM yyyy HH:mm')}"></span>
                    <span th:if="${isPastDeadline}" class="deadline-passed"> (Deadline Passed)</span>
                </p>
            </div>
        </div>

        <!-- Attached Files from Lecturer -->
        <th:block th:if="${assignment.documents != null and !assignment.documents.isEmpty()}">
            <div class="documents" style="margin-top: 16px;">
                <strong><i class="fas fa-paperclip"></i> Attached Files:</strong>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li th:each="doc : ${assignment.documents}" class="file-item">
                        <i class="fas fa-file-alt"></i>
                        <a th:href="@{'/documents/' + ${doc.documentId}}" th:text="${doc.documentTitle} ?: 'File'"></a>
                    </li>
                </ul>
            </div>
        </th:block>
    </div>

    <!-- 1. CHƯA NỘP + CHƯA QUÁ HẠN → FORM NỘP -->
    <div class="panel" th:if="${submission == null and !isPastDeadline}">
        <h3><i class="fas fa-upload"></i> Submit Your Assignment</h3>
        <form method="post"
              th:action="@{/classroom/submit-specialized-assignment}"
              enctype="multipart/form-data"
              onsubmit="return validateFiles(this)">

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="postId" th:value="${assignment.postId}" />
            <input type="hidden" name="classId" th:value="${classId}" />

            <div class="form-group">
                <label for="files"><i class="fas fa-file-upload"></i> Upload Files (max 5, 10MB each):</label>
                <input type="file"
                       id="files"
                       name="files"
                       multiple
                       required
                       class="input"
                       accept=".pdf,.doc,.docx,.txt,.ppt,.pptx,.zip" />
                <small class="text-muted">Supported: PDF, DOC, DOCX, TXT, PPT, PPTX, ZIP</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn primary">
                    <i class="fas fa-paper-plane"></i> Submit Assignment
                </button>
            </div>
        </form>
    </div>

    <!-- 2. ĐÃ NỘP → HIỂN THỊ FILE -->
    <div class="panel" th:if="${submission != null}">
        <h3 class="submit-success"><i class="fas fa-check-circle"></i> You have submitted</h3>
        <p><strong>Submitted at:</strong>
            <span th:text="${#temporals.format(submission.createdAt, 'dd MMM yyyy HH:mm')}"></span>
        </p>

        <div class="documents" th:if="${submission.submissionDocuments != null and !submission.submissionDocuments.isEmpty()}">
            <strong>Your Files:</strong>
            <ul style="margin: 8px 0; padding-left: 20px;">
                <li th:each="doc : ${submission.submissionDocuments}" class="file-item">
                    <i class="fas fa-file-check"></i>
                    <span th:text="${doc.filePath}"></span>
                </li>
            </ul>
        </div>
    </div>

    <!-- 3. QUÁ HẠN + CHƯA NỘP → CẢNH BÁO -->
    <div class="panel" th:if="${submission == null and isPastDeadline}">
        <p class="text-danger" style="font-weight: 600;">
            <i class="fas fa-exclamation-triangle"></i>
            The submission deadline has passed. You can no longer submit this assignment.
        </p>
    </div>

    <!-- Comments Section -->
    <div class="panel">
        <h3><i class="fas fa-comments"></i> Comments (<span th:text="${assignment.getTotalComments()}"></span>)</h3>

        <th:block th:if="${assignment.getAllCommentsSorted() != null and !assignment.getAllCommentsSorted().isEmpty()}">
            <div class="comments-list">
                <div th:each="comment : ${assignment.getAllCommentsSorted()}" class="comment-item">
                    <div class="comment-header">
                        <strong th:text="${comment.getCommenterId()}"></strong>
                        <small th:text="${#temporals.format(comment.createdAt, 'HH:mm dd/MM/yyyy')}"></small>
                    </div>
                    <p th:text="${comment.getContent()}"></p>
                </div>
            </div>
        </th:block>

        <th:block th:if="${assignment.getAllCommentsSorted() == null or assignment.getAllCommentsSorted().isEmpty()}">
            <p class="text-muted">No comments yet.</p>
        </th:block>

        <!-- Add Comment -->
        <form method="post" th:action="@{/classroom/add-comment}" class="mt-3">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="postId" th:value="${assignment.postId}" />
            <input type="hidden" name="classId" th:value="${classId}" />
            <div class="form-group">
                <textarea name="content"
                          rows="3"
                          class="input"
                          placeholder="Add a comment..."
                          required></textarea>
            </div>
            <button type="submit" class="btn primary">
                <i class="fas fa-paper-plane"></i> Post Comment
            </button>
        </form>
    </div>
</div>

<script>
    function validateFiles(form) {
        const files = form.files.files;
        if (files.length > 5) {
            alert("You can upload a maximum of 5 files.");
            return false;
        }
        for (let file of files) {
            if (file.size > 10 * 1024 * 1024) {
                alert("File '" + file.name + "' exceeds 10MB limit.");
                return false;
            }
        }
        return true;
    }
</script>
</body>
</html>