<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <link rel="stylesheet" th:href="@{/MessagesPage.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
</head>
<body>
<div class="messages-app">
    <header class="app-header">
        <a th:href="@{${home}}" class="home-btn">
            <i class="fas fa-home"></i> Home
        </a>
        <h1 class="app-title"><i class="fas fa-comments"></i> Messages</h1>
    </header>

    <div class="app-body">
        <aside class="sidebar" th:if="${partners != null and !#lists.isEmpty(partners)}">
            <div class="sidebar-header">Conversations</div>
            <div class="conversation-list">
                <form th:each="p : ${partners}" method="post" th:action="@{/messages/select-partner}">
                    <input type="hidden" name="partnerId" th:value="${p.id}">
                    <button type="submit"
                            class="conversation-item"
                            th:classappend="${selectedPartner?.id == p.id} ? 'active' : ''">
                        <img class="avatar"
                             th:src="@{|/persons/avatar/${p.id}|}"
                             th:attr="onerror=|this.onerror=null;this.src='${p.defaultAvatarPath}'|"
                             alt="avatar">
                        <div class="info">
                            <div class="name" th:text="${p.firstName + ' ' + p.lastName}">Name</div>
                        </div>
                    </button>
                </form>
            </div>
        </aside>

        <main class="chat-main" th:if="${selectedPartner != null}">
            <div class="chat-header">
                <img class="avatar"
                     th:src="@{|/persons/avatar/${selectedPartner.id}|}"
                     th:attr="onerror=|this.onerror=null;this.src='${selectedPartner.defaultAvatarPath}'|"
                     alt="avatar">
                <div class="partner-name" th:text="${selectedPartner.firstName + ' ' + selectedPartner.lastName}"></div>
            </div>

            <div class="messages-container" id="chatMessages">
                <div th:each="msg : ${messages}"
                     th:class="'message ' + (${msg.sender.id == currentUserId} ? 'outgoing' : 'incoming')">
                    <img class="message-avatar"
                         th:src="@{|/persons/avatar/${msg.sender.id}|}"
                         th:attr="onerror=|this.onerror=null;this.src='${msg.sender.defaultAvatarPath}'|"
                         alt="avatar">
                    <div class="bubble-wrapper">
                        <div class="bubble" th:text="${msg.text}"></div>
                        <div class="time" th:text="${#temporals.format(msg.datetime, 'HH:mm dd/MM/yyyy')}"></div>
                    </div>
                </div>
            </div>

            <form id="sendForm" class="message-input">
                <input type="text" id="messageText" placeholder="Type a message..." autocomplete="off" required>
                <button type="submit" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </main>

        <div class="empty-state" th:if="${selectedPartner == null}">
            <i class="fas fa-comments fa-3x"></i>
            <p>Select a conversation to start chatting</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
    const defaultAvatars = /*[[${defaultAvatarMap}]]*/ {};   // dự phòng
    const currentUserId = /*[[${currentUserId}]]*/ null;
    const selectedPartnerId = /*[[${selectedPartner?.id}]]*/ null;
    let stompClient = null;

    function connect() {
        if (!selectedPartnerId) return;
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/messages.' + currentUserId, message => {
                const msg = JSON.parse(message.body);
                if (msg.senderId === selectedPartnerId || msg.recipientId === selectedPartnerId) {
                    appendMessage(msg);
                }
            });
        });
    }

    function appendMessage(msg) {
        const chat = document.getElementById('chatMessages');
        const isOutgoing = msg.senderId === currentUserId;

        // Ưu tiên senderDefaultAvatarPath từ DTO, sau đó fallback map, cuối cùng default
        const avatarPath = msg.senderDefaultAvatarPath
            || defaultAvatars[msg.senderId]
            || '/img/default-avatar.png';

        const div = document.createElement('div');
        div.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
        div.innerHTML = `
            <img class="message-avatar" src="/persons/avatar/${msg.senderId}"
                 onerror="this.onerror=null;this.src='${avatarPath}'" alt="avatar">
            <div class="bubble-wrapper">
                <div class="bubble">${escapeHtml(msg.text)}</div>
                <div class="time">${new Date(msg.datetime).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}</div>
            </div>`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    document.getElementById('sendForm').addEventListener('submit', e => {
        e.preventDefault();
        const input = document.getElementById('messageText');
        const text = input.value.trim();
        if (text && stompClient?.connected) {
            stompClient.send("/app/chat.send", {}, JSON.stringify({
                recipientId: selectedPartnerId,
                text: text
            }));
            input.value = '';
        }
    });

    if (selectedPartnerId) {
        connect();
        setTimeout(() => document.getElementById('chatMessages').scrollTop = 9999999, 100);
    }
</script>
</body>
</html>