<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Student</title>

    <link rel="stylesheet" th:href="@{/EditStudentForm.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        /* Overlay */
        .overlay {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.75); z-index:9999; justify-content:center;
            align-items:center; backdrop-filter:blur(8px);
        }
        .overlay.active { display:flex; }

        .overlay-content {
            background:#ffffff; padding:30px; border-radius:16px; width:90%;
            max-width:540px; box-shadow:0 20px 60px rgba(0,0,0,0.3); position:relative;
        }

        .close-btn {
            position:absolute; top:10px; right:15px; font-size:32px;
            cursor:pointer; color:#999;
        }
        .close-btn:hover { color:#000; }

        /* Parent table */
        .parents-table-container {
            margin-top:15px; overflow-x:auto; width:100%;
        }
        table.parents-table {
            width:100%; border-collapse:collapse; background:#fff;
            border-radius:12px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.08);
        }
        .parents-table th {
            background:#f1f5f9; padding:12px; font-weight:600; text-align:left;
            border-bottom:2px solid #e2e8f0;
        }
        .parents-table td {
            padding:12px; border-bottom:1px solid #e5e7eb; vertical-align:middle;
        }
        .parents-table tr:hover {
            background:#eef6ff;
        }
        .parent-avatar {
            width:50px; height:50px; border-radius:50%;
            border:2px solid #ddd; object-fit:cover;
        }

        /* Title + Add Parent button on same row */
        .parent-header-bar {
            display:flex; justify-content:space-between; align-items:center;
            margin-bottom:10px;
        }
        .parent-header-bar h2 {
            margin:0; padding:0;
        }
    </style>

</head>

<body>

<div class="win11-container">

    <header class="win11-title-bar">
        <h1><i class="fas fa-user-graduate"></i> Update Student</h1>
    </header>

    <!-- Alerts -->
    <div th:if="${errors?.containsKey('general')}" class="win11-alert error">
        <i class="fas fa-exclamation-circle"></i> <span th:text="${errors['general']}"></span>
    </div>
    <div th:if="${successMessage}" class="win11-alert success">
        <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
    </div>
    <div th:if="${parentSuccess}" class="win11-alert success">
        <i class="fas fa-check-circle"></i> <span th:text="${parentSuccess}"></span>
    </div>
    <div th:if="${parentError}" class="win11-alert error">
        <i class="fas fa-exclamation-triangle"></i> <span th:text="${parentError}"></span>
    </div>

    <div class="win11-content">

        <!-- ===================== MAIN EDIT FORM ===================== -->
        <form method="post"
              th:action="@{/staff-home/students-list/edit-student-form}"
              th:object="${student}" enctype="multipart/form-data">

            <input type="hidden" name="_method" value="put">
            <input type="hidden" th:field="*{id}">
            <input type="hidden" name="searchType" th:value="${searchType}">
            <input type="hidden" name="keyword" th:value="${keyword}">
            <input type="hidden" name="page" th:value="${page}">
            <input type="hidden" name="pageSize" th:value="${pageSize}">
            <input type="hidden" name="source" th:value="${source}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <!-- Avatar -->
            <section class="win11-panel text-center">
                <h2 class="panel-header"><i class="fas fa-image"></i> Avatar</h2>

                <div class="avatar-container">
                    <img th:if="${session.avatarStudent != null}"
                         th:src="@{${session.avatarStudent}}"
                         class="avatar-img">

                    <img th:if="${student.avatar != null && session.avatarStudent == null}"
                         th:src="@{'/staff-home/students-list/avatar/' + ${student.id}}"
                         class="avatar-img">

                    <img th:if="${student.avatar == null && session.avatarStudent == null}"
                         th:src="${student.defaultAvatarPath}"
                         class="avatar-img">
                </div>

                <label for="avatarFile"><i class="fas fa-upload"></i> Upload New Avatar (Optional)</label>
                <input id="avatarFile" type="file" name="avatarFile" accept="image/*" class="input">
            </section>

            <!-- Student Info -->
            <section class="win11-panel">
                <h2 class="panel-header"><i class="fas fa-user"></i> Student Information</h2>

                <div class="form-group grid-2">

                    <div class="form-row">
                        <label>First Name:</label>
                        <input th:field="*{firstName}" required class="input">
                    </div>

                    <div class="form-row">
                        <label>Last Name:</label>
                        <input th:field="*{lastName}" required class="input">
                    </div>

                    <div class="form-row">
                        <label>Email:</label>
                        <input th:field="*{email}" required type="email" class="input">
                    </div>

                    <div class="form-row">
                        <label>Phone Number:</label>
                        <input th:field="*{phoneNumber}" required class="input">
                    </div>

                    <div class="form-row">
                        <label>Birth Date:</label>
                        <input th:field="*{birthDate}" type="date" class="input">
                    </div>

                    <div class="form-row">
                        <label>Admission Year:</label>
                        <input th:field="*{admissionYear}" required class="input">
                    </div>

                    <div class="form-row">
                        <label>Gender:</label>
                        <select th:field="*{gender}" class="input">
                            <option value="">Select gender</option>
                            <option th:each="g : ${genders}" th:value="${g}" th:text="${g}"></option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label>Curriculum:</label>
                        <select name="curriculumId" required class="input">
                            <option value="">Select Curriculum</option>
                            <option th:each="c : ${curriculums}"
                                    th:value="${c.curriculumId}"
                                    th:text="${c.name}"
                                    th:selected="${student?.curriculum?.curriculumId == c.curriculumId}">
                            </option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label>Narrow Specialization:</label>
                        <select name="specializationId" required class="input">
                            <option value="">Select Specialization</option>
                            <option th:each="s : ${specializations}"
                                    th:value="${s.specializationId}"
                                    th:text="${s.specializationName}"
                                    th:selected="${student?.specialization?.specializationId == s.specializationId}">
                            </option>
                        </select>
                    </div>

                </div>
            </section>

            <!-- Address -->
            <section class="win11-panel">
                <h2 class="panel-header"><i class="fas fa-map-marker-alt"></i> Address Information</h2>

                <div class="form-group grid-2">
                    <div class="form-row"><label>Country:</label><input th:field="*{country}" class="input"></div>
                    <div class="form-row"><label>Province:</label><input th:field="*{province}" class="input"></div>
                    <div class="form-row"><label>City:</label><input th:field="*{city}" class="input"></div>
                    <div class="form-row"><label>District:</label><input th:field="*{district}" class="input"></div>
                    <div class="form-row"><label>Ward:</label><input th:field="*{ward}" class="input"></div>
                    <div class="form-row"><label>Street:</label><input th:field="*{street}" class="input"></div>
                    <div class="form-row"><label>Postal Code:</label><input th:field="*{postalCode}" class="input"></div>
                </div>
            </section>

            <!-- Save Buttons -->
            <div class="form-actions">
                <button type="submit" class="btn primary"><i class="fas fa-save"></i> Save Student Changes</button>

                <a th:if="${source == 'search'}"
                   th:href="@{/staff-home/search-students(page=${page}, pageSize=${pageSize}, searchType=${searchType}, keyword=${keyword})}"
                   class="btn"><i class="fas fa-arrow-left"></i> Back</a>

                <a th:if="${source != 'search'}"
                   th:href="@{/staff-home/students-list(page=${page}, pageSize=${pageSize})}"
                   class="btn"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
        </form>

        <!-- ===================== LINKED PARENTS ===================== -->
        <section class="win11-panel" style="margin-top:40px;">

            <div class="parent-header-bar">
                <h2 class="panel-header"><i class="fas fa-users"></i> Linked Parents</h2>

                <button type="button" class="btn primary" onclick="openParentOverlay()">
                    <i class="fas fa-user-plus"></i> Add Parent
                </button>
            </div>

            <div th:if="${#lists.isEmpty(parentLinks)}">
                <p>No parents linked yet.</p>
            </div>

            <div th:unless="${#lists.isEmpty(parentLinks)}" class="parents-table-container">
                <table class="parents-table">
                    <thead>
                    <tr>
                        <th><i class="fas fa-image"></i> Avatar</th>
                        <th><i class="fas fa-user"></i> Full Name</th>
                        <th><i class="fas fa-envelope"></i> Email</th>
                        <th><i class="fas fa-heart"></i> Relationship</th>
                        <th><i class="fas fa-phone"></i> Support Phone</th>
                        <th><i class="fas fa-cogs"></i> Action</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="link : ${parentLinks}">
                        <td>
                            <img th:if="${link.parent.avatar != null}"
                                 th:src="@{'/staff-home/parent/avatar/' + ${link.parent.id}}"
                                 class="parent-avatar">

                            <img th:if="${link.parent.avatar == null}"
                                 th:src="${link.parent.defaultAvatarPath}"
                                 class="parent-avatar">
                        </td>

                        <td th:text="${link.parent.fullName} ?: 'Unnamed Parent'"></td>

                        <td th:text="${link.parent.email}"></td>

                        <td th:text="${link.relationshipToStudent}"></td>

                        <td th:text="${link.supportPhoneNumber ?: 'N/A'}"></td>

                        <td>
                            <form method="post" th:action="@{/staff-home/students-list/remove-parent-link}"
                                  onsubmit="return confirm('Remove this parent from the student?');">

                                <input type="hidden" name="studentId" th:value="${student.id}">
                                <input type="hidden" name="parentId" th:value="${link.parent.id}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                                <button type="submit" class="btn danger small">
                                    <i class="fas fa-trash-alt"></i> Remove
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </section>

    </div>
</div>

<!-- Parent Add Popup -->
<div id="parentOverlay" class="overlay">
    <div class="overlay-content">
        <span class="close-btn" onclick="closeParentOverlay()">Ã—</span>

        <h2 style="text-align:center; margin-bottom:20px;">
            <i class="fas fa-user-plus"></i> Add Parent for<br>
            <strong th:text="${student.firstName + ' ' + student.lastName}"></strong>
        </h2>

        <form method="post" th:action="@{/staff-home/students-list/add-parent-to-student}">
            <input type="hidden" name="studentId" th:value="${student.id}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <div class="form-row">
                <label><i class="fas fa-envelope"></i> Parent Email *</label>
                <input type="email" name="parentEmail" required class="input" placeholder="parent@example.com">
            </div>

            <div class="form-row">
                <label><i class="fas fa-heart"></i> Relationship</label>
                <select name="relationship" class="input">
                    <option th:each="rel : ${T(com.example.demo.entity.Enums.RelationshipToStudent).values()}"
                            th:value="${rel.name()}"
                            th:text="${rel}"
                            th:selected="${rel.name() == 'MOTHER'}"></option>
                </select>
            </div>

            <div class="form-row">
                <label><i class="fas fa-phone"></i> Support Phone (Optional)</label>
                <input type="text" name="supportPhoneNumber" class="input" placeholder="+84xxxxxxxxx">
            </div>

            <div class="form-actions" style="margin-top:25px; justify-content:center;">
                <button type="submit" class="btn primary"><i class="fas fa-paper-plane"></i> Add Parent</button>
                <button type="button" class="btn danger" onclick="closeParentOverlay()">Cancel</button>
            </div>
        </form>

    </div>
</div>

<script>
    function openParentOverlay(){ document.getElementById('parentOverlay').classList.add('active'); }
    function closeParentOverlay(){ document.getElementById('parentOverlay').classList.remove('active'); }
</script>

</body>
</html>
