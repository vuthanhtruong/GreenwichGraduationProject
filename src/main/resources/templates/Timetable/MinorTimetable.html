<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minor Timetable</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/MajorTimetable.css}">
</head>

<body>
<div class="timetable-container">

    <!-- ========================= HEADER ========================= -->
    <header class="timetable-header">

        <div class="header-main">
            <h1>
                <i class="fas fa-calendar-alt"></i>
                Arrange timetable for <span th:text="${className}"></span>
                at <span th:text="${classCreatorCampusName ?: 'Unknown Campus'}"></span>
            </h1>

            <form th:action="@{/deputy-staff-home/minor-classes-list/minor-timetable}"
                  method="post"
                  class="inline-form header-form">

                <input type="hidden" name="classId" th:value="${classId}">

                <div class="select-group">
                    <label><i class="fas fa-calendar-year"></i> Year</label>
                    <select name="year" onchange="this.form.submit()">
                        <option th:each="y : ${#numbers.sequence(currentYear - 5, currentYear + 5)}"
                                th:value="${y}" th:text="${y}" th:selected="${y == year}"></option>
                    </select>
                </div>

                <div class="select-group">
                    <label><i class="fas fa-calendar-week"></i> Week</label>
                    <select name="week" onchange="this.form.submit()">
                        <option th:each="label, iter : ${weekLabels}"
                                th:value="${iter.index + 1}" th:text="${label}"
                                th:selected="${iter.index + 1 == week}"></option>
                    </select>
                </div>
            </form>
        </div>

        <div class="header-controls">
            <button type="submit" form="timetableForm" class="btn btn-success"
                    th:disabled="${isPast || isFullyScheduled}"
                    th:title="${isFullyScheduled} ? 'Class is fully scheduled' :
                             (isPast ? 'Cannot save in past weeks' : '')">
                <i class="fas fa-save"></i>
                <span th:text="${isFullyScheduled} ? 'Fully Scheduled' : 'Save All'"></span>
            </button>

            <a th:href="@{/deputy-staff-home/minor-classes-list/clear-class}"
               class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </header>

    <!-- ========================= SLOT STATUS ========================= -->
    <div class="slot-status-container" th:if="${totalRequiredSlots > 0}">
        <div class="status-row">

            <div class="slot-status">

                <div class="status-item">
                    <strong>Required:</strong> <span th:text="${totalRequiredSlots}"></span> slots
                </div>

                <div class="status-item">
                    <strong>Booked:</strong> <span th:text="${totalBookedSlots}"></span>
                </div>

                <div class="status-item"
                     th:classappend="${remainingTotalSlots <= 0} ? 'text-success' : 'text-warning'">
                    <strong>Remaining:</strong>
                    <span th:text="${remainingTotalSlots > 0} ?
                                    ${remainingTotalSlots} + ' slot(s)' :
                                    'Fully scheduled'"></span>
                </div>

                <div class="slot-status-week">
                    <em>This week: <span th:text="${bookedSlotsInWeek}"></span> slot(s)</em>
                </div>

            </div>

            <div class="action-buttons">

                <!-- SEND NOTIFICATION -->
                <form th:action="@{/deputy-staff-home/minor-classes-list/minor-timetable/send-notification}"
                      method="post"
                      class="inline-form">

                    <input type="hidden" name="classId" th:value="${classId}">
                    <input type="hidden" name="year" th:value="${year}">
                    <input type="hidden" name="week" th:value="${week}">

                    <button type="submit" class="btn btn-outline-info btn-sm"
                            onclick="return confirm('Send timetable notification to students?');">
                        <i class="fas fa-bell"></i> Send Notification
                    </button>
                </form>

                <!-- VIEW ALL -->
                <form th:action="@{/deputy-staff-home/minor-classes-list/minor-timetable/view-all}"
                      method="post"
                      class="inline-form">

                    <input type="hidden" name="classId" th:value="${classId}">
                    <button type="submit" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-list-alt"></i> View All Schedules
                    </button>
                </form>

            </div>
        </div>
    </div>

    <!-- ========================= ALERTS ========================= -->
    <div th:if="${success}" class="alert alert-success">
        <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
    </div>

    <div th:if="${error}" class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> <span th:utext="${error}"></span>
    </div>

    <div th:if="${info}" class="alert alert-info">
        <i class="fas fa-info-circle"></i> <span th:text="${info}"></span>
    </div>

    <div th:if="${isPast}" class="alert alert-warning">
        <i class="fas fa-history"></i>
        <strong>Past week</strong> â€“ cannot schedule past weeks.
    </div>

    <!-- ========================= MAIN FORM (SAVE ALL) ========================= -->
    <form id="timetableForm"
          th:action="@{/deputy-staff-home/minor-classes-list/minor-timetable/save-all}"
          method="post">

        <input type="hidden" name="year" th:value="${year}">
        <input type="hidden" name="week" th:value="${week}">

        <div class="table-wrapper">
            <table class="timetable-table">

                <thead>
                <tr>
                    <th class="slot-header">
                        <div>Slot</div>
                        <small>Day</small>
                    </th>
                    <th th:each="d, st : ${dayLabels}" class="day-header">
                        <span class="day-name" th:text="${dayNames[st.index]}"></span>
                        <small th:text="'(' + ${d} + ')'"></small>
                    </th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="slot, slotStat : ${slots}">

                    <!-- SLOT INFO -->
                    <td class="slot-cell">
                        <div class="slot-name" th:text="${slot.slotName}"></div>
                        <div class="slot-time">
                            <i class="far fa-clock"></i>
                            <span th:text="${#temporals.format(slot.startTime, 'HH:mm')}
                                            + ' - ' +
                                            ${#temporals.format(slot.endTime, 'HH:mm')}">
                            </span>
                        </div>
                    </td>

                    <!-- DAYS -->
                    <td th:each="dayIdx : ${#numbers.sequence(0, 6)}"
                        class="timetable-cell">

                        <!-- BOOKED -->
                        <div th:if="${bookedTimetableMatrix[dayIdx][slotStat.index] != null}"
                             class="cell cell-booked">

                            <div class="cell-content">
                                <div class="room-name">
                                    <i class="fas fa-door-open"></i>
                                    <strong th:text="${bookedTimetableMatrix[dayIdx][slotStat.index].room.roomName
                                                      ?: bookedTimetableMatrix[dayIdx][slotStat.index].room.roomId}">
                                    </strong>
                                </div>

                                <!-- Room Link -->
                                <div class="room-link"
                                     th:if="${bookedTimetableMatrix[dayIdx][slotStat.index].room.link != null}">
                                    <i class="fas fa-link"></i>
                                    <a th:href="${bookedTimetableMatrix[dayIdx][slotStat.index].room.link}"
                                       target="_blank"
                                       class="link">Enter Link</a>
                                </div>

                                <!-- Address -->
                                <div class="room-address"
                                     th:if="${bookedTimetableMatrix[dayIdx][slotStat.index].room.getAddress() != null}">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <a th:href="@{https://www.google.com/maps/search/?api=1&query=${#strings.replace(bookedTimetableMatrix[dayIdx][slotStat.index].room.getAddress(), ' ', '+')}}"
                                       target="_blank"
                                       class="link">Check Address</a>
                                </div>

                                <div class="creator-info"
                                     th:if="${bookedTimetableMatrix[dayIdx][slotStat.index].creator != null}">
                                    <i class="fas fa-user"></i>
                                    <span th:text="${bookedTimetableMatrix[dayIdx][slotStat.index].creator.fullName}"></span>
                                </div>

                                <div class="created-at">
                                    <i class="fas fa-clock"></i>
                                    <span th:text="${#temporals.format(bookedTimetableMatrix[dayIdx][slotStat.index].createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                </div>

                                <!-- BUTTONS -->
                                <button type="submit"
                                        class="btn btn-info btn-sm"
                                        th:form="'detailForm_' + ${dayIdx} + '_' + ${slotStat.index}">
                                    <i class="fas fa-eye"></i> Detail Class
                                </button>

                                <button type="submit"
                                        class="btn-delete"
                                        th:form="'deleteForm_' + ${dayIdx} + '_' + ${slotStat.index}"
                                        onclick="return confirm('Delete this schedule?')">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>

                            </div>
                        </div>

                        <!-- AVAILABLE -->
                        <div th:if="${bookedTimetableMatrix[dayIdx][slotStat.index] == null
                                     && !availableRoomsMatrix[dayIdx][slotStat.index].isEmpty()
                                     && !isPast}"
                             class="cell cell-available">

                            <select class="room-select"
                                    th:name="'room_' + ${dayIdx} + '_' + ${slotStat.index}">
                                <option value="">-- Select Room --</option>

                                <option th:each="roomId : ${availableRoomsMatrix[dayIdx][slotStat.index]}"
                                        th:value="${roomId}"
                                        th:text="${roomId}"></option>
                            </select>

                            <input type="hidden"
                                   th:name="'slotId_' + ${dayIdx} + '_' + ${slotStat.index}"
                                   th:value="${slot.slotId}">
                        </div>

                        <!-- UNAVAILABLE -->
                        <div th:if="${bookedTimetableMatrix[dayIdx][slotStat.index] == null
                                     && (isPast || availableRoomsMatrix[dayIdx][slotStat.index].isEmpty())}"
                             class="cell cell-unavailable">
                            <i class="fas fa-ban"></i>
                            <span th:text="${isPast} ? 'Not available (past week)' : 'No room available'"></span>
                        </div>

                    </td>
                </tr>
                </tbody>

            </table>
        </div>
    </form>

    <!-- ========================= STANDALONE FORMS (NO CONFLICTS) ========================= -->
    <th:block th:each="slot, slotStat : ${slots}">
        <th:block th:each="dayIdx : ${#numbers.sequence(0, 6)}">

            <!-- DETAIL FORM -->
            <form th:id="'detailForm_' + ${dayIdx} + '_' + ${slotStat.index}"
                  th:action="@{/minor-timetable/detail}"
                  method="post" hidden>
                <input type="hidden" name="classId" th:value="${classId}">
                <input type="hidden" name="timetableId"
                       th:value="${bookedTimetableMatrix[dayIdx][slotStat.index]?.timetableId}">
            </form>

            <!-- DELETE FORM -->
            <form th:id="'deleteForm_' + ${dayIdx} + '_' + ${slotStat.index}"
                  th:action="@{/deputy-staff-home/minor-classes-list/minor-timetable/delete}"
                  method="post" hidden>
                <input type="hidden" name="year" th:value="${year}">
                <input type="hidden" name="week" th:value="${week}">
                <input type="hidden" name="timetableId"
                       th:value="${bookedTimetableMatrix[dayIdx][slotStat.index]?.timetableId}">
            </form>

        </th:block>
    </th:block>

</div>
</body>
</html>
