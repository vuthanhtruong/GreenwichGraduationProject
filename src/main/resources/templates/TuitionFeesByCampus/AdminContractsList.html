<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Academic Contracts</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/SyllabusesList.css}">
    <style>
        .win11-container { padding: 20px; }
        .search-toolbar { display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; }
        .toolbar-left { display:flex; align-items:center; gap:1rem; }
        .toolbar-center { display:flex; align-items:center; gap:.5rem; }
        .toolbar-right { display:flex; align-items:center; gap:1rem; }
        .panel-header { font-size:1.05rem; margin:0; display:flex; align-items:center; gap:.5rem; }
        .form-actions { padding: 12px 16px; background:#f8f9fa; border-top:1px solid #e9ecef; text-align:right; }
        .btn.primary { background: #0d6efd; color: #fff; border: none; padding:8px 16px; border-radius:6px; }
        .btn.primary:hover { background:#0b5ed7; }
        .badge-status { min-width:90px; display:inline-block; text-align:center; padding:.4rem .6rem; border-radius:.375rem; }
        .bg-success { background-color:#198754; color:#fff; }
        .bg-warning { background-color:#ffc107; color:#212529; }
        .contract-cell { display:flex; align-items:center; gap:.6rem; }
        @media (max-width: 768px) {
            .table-responsive { overflow-x:auto; }
            .contract-cell { flex-direction:column; align-items:flex-start; gap:.25rem; }
        }
    </style>
</head>
<body>
<div class="win11-container">

    <!-- ==== Unified Toolbar (Consistent Admin Layout) ==== -->
    <div class="search-toolbar unified-bar">

        <!-- LEFT: Home + Title -->
        <div class="toolbar-left">
            <a th:href="@{/admin-home}" class="btn btn-outline-secondary">
                <i class="fas fa-home"></i> Home
            </a>

            <h2 class="page-title mb-0">
                <i class="fas fa-file-contract"></i>
                Manage Academic Contracts
            </h2>
        </div>

        <!-- CENTER: Filter by Admission Year -->
        <form method="post" th:action="@{/admin-home/contracts-list}" class="toolbar-center">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <label for="admissionYear" class="mb-0"><i class="fas fa-calendar-alt"></i> Year:</label>
            <select id="admissionYear" name="admissionYear" class="form-select form-select-sm"
                    style="width:auto;" onchange="this.form.submit()">
                <option value="" disabled th:unless="${admissionYears.size() > 0}">No years available</option>
                <option th:each="year : ${admissionYears}"
                        th:value="${year}"
                        th:text="${year}"
                        th:selected="${year == selectedYear}">
                </option>
            </select>
        </form>

        <!-- RIGHT: Totals -->
        <div class="toolbar-right">
            <div class="total">
                <i class="fas fa-list"></i>
                <strong>Total Subjects:</strong>
                <span th:text="${tuitionsWithFee.size()}">0</span>
            </div>

            <div class="total">
                <i class="fas fa-award"></i>
                <strong>Total Scholarships:</strong>
                <span th:text="${allScholarships.size()}">0</span>
            </div>
        </div>
    </div>

    <!-- === FORM: finalize (bao cả tuition và scholarship) === -->
    <form th:action="@{/admin-home/contracts-list/finalize}" method="post">
        <input type="hidden" name="admissionYear" th:value="${selectedYear}" />
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- Combined Subjects Table -->
        <section class="card mb-4">
            <div class="card-header">
                <h3 class="panel-header mb-0">
                    <i class="fas fa-coins"></i>
                    Subjects with Tuition and Re-study Fees — <span th:text="${selectedYear}"></span>
                </h3>
            </div>

            <div class="card-body table-responsive p-0">
                <table class="table table-bordered table-striped mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>Subject ID</th>
                        <th>Subject Name</th>
                        <th>Subject Major</th>
                        <th>Subject Type</th>
                        <th>Admission Year</th>
                        <th>Creator</th>
                        <th>Creator Email</th>
                        <th>Campus</th>
                        <th>Standard Tuition Fee</th>
                        <th>Re-study Fee</th>
                        <th>Contract Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="tuition : ${tuitionsWithFee}"
                        th:classappend="${tuition.contractStatus == T(com.example.demo.entity.Enums.ContractStatus).ACTIVE} ? 'table-success' : ''">
                        <td th:text="${tuition.subject.subjectId}"></td>
                        <td th:text="${tuition.subject.subjectName}"></td>
                        <td th:text="${tuition.getSubjectMajor()}"></td>
                        <td th:text="${tuition.getSubjectType()}"></td>
                        <td th:text="${tuition.id.admissionYear}"></td>
                        <td th:text="${tuition.creator != null ? tuition.creator.fullName : 'N/A'}"></td>
                        <td th:text="${tuition.creator != null ? tuition.creator.email : 'N/A'}"></td>
                        <td th:text="${tuition.campus != null ? tuition.campus.campusName : 'N/A'}"></td>
                        <td th:text="${tuition.tuition != null ? tuition.tuition + ' USD' : 'N/A'}"></td>
                        <td th:text="${tuition.reStudyTuition != null ? tuition.reStudyTuition + ' USD' : 'N/A'}"></td>

                        <!-- Contract column: badge always, checkbox only when NOT ACTIVE -->
                        <td>
                            <div class="contract-cell">
                                <div th:if="${tuition.contractStatus != T(com.example.demo.entity.Enums.ContractStatus).ACTIVE}">
                                    <input type="checkbox" class="form-check-input"
                                           name="tuitionIds"
                                           th:value="${tuition.subject.subjectId}"
                                           aria-label="Select tuition contract"/>
                                </div>

                                <div>
                                    <span th:text="${tuition.contractStatus}"
                                          th:classappend="${tuition.contractStatus == T(com.example.demo.entity.Enums.ContractStatus).ACTIVE} ? 'badge-status bg-success' : 'badge-status bg-warning'">
                                    </span>
                                </div>
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(tuitionsWithFee)}">
                        <td colspan="11" class="text-center py-3">No tuition/re-study records for selected year.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn primary">
                    <i class="fas fa-check"></i> Finalize Selected
                </button>
            </div>
        </section>

        <!-- Scholarships Table -->
        <section class="card">
            <div class="card-header">
                <h3 class="panel-header mb-0">
                    <i class="fas fa-award"></i>
                    Scholarships — <span th:text="${selectedYear}"></span>
                </h3>
            </div>

            <div class="card-body table-responsive p-0">
                <table class="table table-bordered table-striped mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>Scholarship ID</th>
                        <th>Type Name</th>
                        <th>Admission Year</th>
                        <th>Creator</th>
                        <th>Creator Email</th>
                        <th>Amount</th>
                        <th>Discount (%)</th>
                        <th>Contract Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="scholarship : ${allScholarships}"
                        th:if="${scholarshipByYearMap[scholarship.scholarshipId] != null}"
                        th:classappend="${scholarshipByYearMap[scholarship.scholarshipId].contractStatus == T(com.example.demo.entity.Enums.ContractStatus).ACTIVE} ? 'table-success' : ''">
                        <td th:text="${scholarship.scholarshipId}"></td>
                        <td th:text="${scholarship.typeName}"></td>
                        <td th:text="${scholarshipByYearMap[scholarship.scholarshipId].id.admissionYear}"></td>
                        <td th:text="${scholarshipByYearMap[scholarship.scholarshipId].creator != null ? scholarshipByYearMap[scholarship.scholarshipId].creator.fullName : 'N/A'}"></td>
                        <td th:text="${scholarshipByYearMap[scholarship.scholarshipId].creator != null ? scholarshipByYearMap[scholarship.scholarshipId].creator.email : 'N/A'}"></td>
                        <td th:text="${scholarshipByYearMap[scholarship.scholarshipId].amount != null ? scholarshipByYearMap[scholarship.scholarshipId].amount + ' USD' : 'N/A'}"></td>
                        <td th:text="${scholarshipByYearMap[scholarship.scholarshipId].discountPercentage != null ? scholarshipByYearMap[scholarship.scholarshipId].discountPercentage : 'N/A'}"></td>

                        <!-- Contract column: badge always, checkbox only when NOT ACTIVE -->
                        <td>
                            <div class="contract-cell">
                                <div th:if="${scholarshipByYearMap[scholarship.scholarshipId].contractStatus != T(com.example.demo.entity.Enums.ContractStatus).ACTIVE}">
                                    <input type="checkbox" class="form-check-input"
                                           name="scholarshipIds"
                                           th:value="${scholarship.scholarshipId}"
                                           aria-label="Select scholarship contract"/>
                                </div>

                                <div>
                                    <span th:text="${scholarshipByYearMap[scholarship.scholarshipId].contractStatus}"
                                          th:classappend="${scholarshipByYearMap[scholarship.scholarshipId].contractStatus == T(com.example.demo.entity.Enums.ContractStatus).ACTIVE} ? 'badge-status bg-success' : 'badge-status bg-warning'">
                                    </span>
                                </div>
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(allScholarships) or #lists.isEmpty(scholarshipByYearMap)}">
                        <td colspan="8" class="text-center py-3">No scholarship records for selected year.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn primary">
                    <i class="fas fa-check"></i> Finalize Selected
                </button>
            </div>
        </section>
    </form>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
